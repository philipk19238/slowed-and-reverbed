{% extends "base.html" %}
{% block title %}Music Upload{% endblock %}
{% block content %}
    <div class="row justify-content-center header">
    <h1 class='display-4'>choose your reverb.</h1>
</div>
<div class="row justify-content-center lead">
    <p class="lead">Your song. Your vibe.</p>
</div>


<div class="jumbotron reverb">
        <form class="card-deck reverb" action="/upload-music" method="POST">
            <div class="card reverb">
                <div class="card-header">
                    <span class="dot" id="dot1"></span>
                    <span class="dot" id="dot2"></span>
                    <span class="dot" id="dot3"></span>

                </div>
                <div class="card-body">
                <p style="text-align: center"><img class="card-img-top mx-auto d-block" src="https://image.flaticon.com/icons/svg/583/583007.svg"></p>
                </div>
                <div class="card-footer">
                    <h5 class="card-title" style="text-align: center"><button class="btn btn-primary reverb" name="reverb" id="impulse0" value="Greek 7 Echo Hall" data-toggle="modal" data-target="#uploadChoice" onclick="user_choice(this.id);" type="button"><h5 id="button_style">greek theatre</h5></button></h5>
                </div>
            </div>
       
        
            <div class="card reverb">
                <div class="card-header">
                    <span class="dot" id="dot1"></span>
                    <span class="dot" id="dot2"></span>
                    <span class="dot" id="dot3"></span>

                </div>
                <div class="card-body">
                <p style="text-align: center"><img class="card-img-top" src="https://image.flaticon.com/icons/svg/2830/2830354.svg"></p>
                </div>
                <div class="card-footer">
                    <h5 class="card-title" style="text-align: center"><button class="btn btn-primary reverb" name="reverb" id="impulse1" value="French 18th Century Salon" data-toggle="modal" data-target="#uploadChoice" type="button" onclick="user_choice(this.id);"><h5 id="button_style">city hall</h5></button></h5>
                </div>
            </div>
       
       
            <div class="card reverb">
                <div class="card-header">
                    <span class="dot" id="dot1"></span>
                    <span class="dot" id="dot2"></span>
                    <span class="dot" id="dot3"></span>

                </div>
                <div class="card-body">
                <p style="text-align: center"><img class="card-img-top" src="https://image.flaticon.com/icons/svg/2132/2132457.svg"></p>
                </div>
                <div class="card-footer">
                    <h5 class="card-title" style="text-align: center"><button class="btn btn-primary reverb" name="reverb" id="impulse2" value="Small Drum Room" data-toggle="modal" data-target="#uploadChoice" type="button" onclick="user_choice(this.id);"><h5 id="button_style">recording studio</h5></button></h5>
                </div>
            </div>
      
        </form>

        <form class="card-deck reverb" action="/upload-music" method="POST">
          
                <div class="card reverb">
                    <div class="card-header">
                    <span class="dot" id="dot1"></span>
                    <span class="dot" id="dot2"></span>
                    <span class="dot" id="dot3"></span>
                </div>
                    <div class="card-body">
                    <p style="text-align: center"><img class="card-img-top" src="https://image.flaticon.com/icons/svg/2240/2240730.svg"></p>
                    </div>
                    <div class="card-footer">
                    <h5 class="card-title" style="text-align: center"><button class="btn btn-primary reverb" name="reverb" id="impulse3" value="Deep Space" data-toggle="modal" data-target="#uploadChoice" type="button" onclick="user_choice(this.id);"><h5 id="button_style">deep space</h5></button></h5>
                </div>
                </div>
           
                <div class="card reverb">
                    <div class="card-header">
                    <span class="dot" id="dot1"></span>
                    <span class="dot" id="dot2"></span>
                    <span class="dot" id="dot3"></span>

                    </div>
                    <div class="card-body">
                    <p style="text-align: center"><img class="card-img-top" src="https://image.flaticon.com/icons/svg/1778/1778282.svg"></p>
                    </div>
                    <div class="card-footer">
                    <h5 class="card-title" style="text-align: center"><button class="btn btn-primary reverb" name="reverb" id="impulse4" value="Parking Garage" data-toggle="modal" data-target="#uploadChoice" type="button" onclick="user_choice(this.id);"><h5 id="button_style">parking garage</h5></button></h5>
                </div>
                </div>
           
        
                <div class="card reverb">
                    <div class="card-header">
                    <span class="dot" id="dot1"></span>
                    <span class="dot" id="dot2"></span>
                    <span class="dot" id="dot3"></span>

                    </div>
                    <div class="card-body">
                    <p style="text-align: center"><img class="card-img-top" src="https://image.flaticon.com/icons/svg/1861/1861320.svg"></p>
                    </div>
                    <div class="card-footer">
                    <h5 class="card-title" style="text-align: center"><button class="btn btn-primary reverb" name="reverb" id="impulse5" value="Scala Milan Opera Hall" data-toggle="modal" data-target="#uploadChoice" type="button" onclick="user_choice(this.id);"><h5 id="button_style">concert hall</h5></button></h5>
                </div>
                </div>
           
        </div>
    </form>
</div>


<div class="modal fade bd-example-modal-lg" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true" id="close_button" class="dot"></span>
        </button> 
      </div>
      <div class="modal-body">
        <div class="row title">
            <div class="col">
                <h1 class="display-4 music-upload">Upload Music</h1>
            </div>
        </div>
        <div class="row body">
            <div class="col">
                <form action="/upload-music" method="POST" enctype="multipart/form-data">
                    <div class="custom-file">
                        <input oninput="filesize(this);" type="file" class="custom-file-input" name="music" id="music">
                        <label class="custom-file-label" for="music">Choose File</label>
                    </div>
                        <p style="text-align: center;"><button type="submit" class="btn btn-secondary" id="upload_button">Upload</button><p>
                </form>
            </div>
        </div>
 
      </div>
      <div class="modal-footer">
      </div>
  </div>
    </div>
  </div>
</div>


<div class="modal fade bd-example-modal-lg" id="uploadChoice" tabindex="-1" role="dialog" aria-labelledby="uploadChoiceLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true" id="close_button" class="dot"></span>
        </button> 
      </div>
      <div class="modal-body upload-choice">
        <div class="flashes">
            {% for message in get_flashed_messages() %}
             {{message}}
            {% endfor %}
        </div>
        <div class="row">
            <div class="col">
                <h1 class="display-4 upload-choice">Select upload method</h1>
            </div>
        </div>
        <div class="card-deck upload-choice">
            <button class="card upload-button d-flex align-items-center justify-content-center" id="computer" onclick="video_upload()">
                <img class="card-img-top upload-choice" src="https://image.flaticon.com/icons/svg/2223/2223754.svg">
            </button>
            <button class="card upload-button d-flex align-items-center justify-content-center" id="youtube" onclick="youtube()">
                <img class="card-img-top upload-choice" src="https://image.flaticon.com/icons/svg/814/814106.svg">
            </button>
        </div>
      </div>
      <div class="modal-footer">
      </div>
  </div>
    </div>
  </div>
</div>

<div class="modal fade bd-example-modal-lg" id="youtubeChoice" tabindex="-1" role="dialog" aria-labelledby="youtubeChoiceLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true" id="close_button" class="dot"></span>
        </button> 
      </div>
      <div class="modal-body">
        <div class="row title">
            <div class="col">
                <h1 class="display-4 music-upload">YouTube to Mp3</h1>
            </div>
        </div>
        <div class="row body">
            <div class="col">
                    <div class="form-group">
                        <input type="url" class="form-control" id="file_input" placeholder="Enter YouTube URL">
                    </div>
                    <p style="text-align: center;"><button class="btn btn-secondary" id="upload_btn" onclick="upload('{{request.url}}')">Upload</button><p>
                    <p style="text-align: center;"><img src="/static/ajax-loader.gif"/ id="loading_gif" class="d-none"></p>
            </div>
            <div id="alert_wrapper"></div>
        </div>

        <div class="row">
            <div class="col d-flex justify-content-center">
                <audio controls id="audio" class='d-none'>
                    <source src="" type="audio/mp3" id="music_player">
                </audio>
            </div>
        </div>
      </div>
      <div class="modal-footer">
      </div>
  </div>
    </div>
  </div>
</div>

{% endblock %}

{% block script %}
<script>
    function filesize(elem){
    var size = elem.files[0].size;
    document.cookie = 'filesize=' + size;
    }
</script>

<script>
    function user_choice(id){
        var impulse = document.getElementById(id).value;
        document.cookie = 'user_choice=' + impulse;
    }
</script>

<script>
    function video_upload(){
        $("#uploadChoice").modal('hide');
        $("#exampleModal").modal();
    }
</script>

<script>
    function youtube(){
        $("#uploadChoice").modal('hide');
        $("#youtubeChoice").modal();

    }
</script>

<script>
    function clear_form(){
        $(document).on('click', '#upload_button', function(){
            $('#url_box').value="";
        })
    }
</script>

<script type="text/javascript">

    var input = document.getElementById('file_input');

    function show_alert(message, alert){
        alert_wrapper.innerHTML= `
                <div class="alert alert-${alert} alert-dismissible fade show" role="alert">
                    <span>${message}</span>
                    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                `;
    };

    function upload(url){

        if (!input.value) {
            show_alert("No file selected", "warning");
            return;
        }

        var request = new XMLHttpRequest();

        request.responseType = "json";

        var upload_btn = document.getElementById('upload_btn');

        var loading_gif = document.getElementById('loading_gif');

        var file_input = document.getElementById('file_input');

        alert_wrapper.innerHTML = "";

        input.disabled = true;

        upload_btn.classList.add('d-none');

        loading_gif.classList.remove('d-none');

        request.addEventListener("load", function(e){

            if (request.status == 200){
                show_alert(`${request.response.message}`, 'success');
                document.getElementById('music_player').src = `/static/music/uploads/${request.response.message}`;
                loading_gif.classList.add('d-none');
                file_input.classList.add('d-none');
                document.getElementById('audio').classList.remove('d-none');
                document.getElementById('audio').load();
                document.getElementById('audio').play();
            }

            else{
                show_alert('Error', 'danger');
            }
        })

        request.open('POST', url);
        request.setRequestHeader('Content-Type', 'application/json');
        request.send(JSON.stringify({'url':input.value}))
    }

</script>

{% endblock %}


